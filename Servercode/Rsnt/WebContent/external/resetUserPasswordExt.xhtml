<ui:composition xmlns="http://www.w3.org/1999/xhtml"
	xmlns:h="http://java.sun.com/jsf/html"
	xmlns:f="http://java.sun.com/jsf/core"
	xmlns:ui="http://java.sun.com/jsf/facelets"
	xmlns:s="http://jboss.com/products/seam/taglib"
	xmlns:a4j="http://richfaces.org/a4j"
	xmlns:ajax="https://ajax4jsf.dev.java.net/ajax"
	xmlns:rich="http://richfaces.org/rich"
	 template="../layout/externalTemplate.xhtml">
	
	<ui:define name="head">
		<script>
		function addSafeDataValidation() {
			
			$jquery( "#passwordForm").validate({
			  debug : true,
		      rules: {
			      "passwordForm:newPassword": { 
			    	required: true,
			    	
			      },
			      "passwordForm:confirmPassword": { 
			        	required: true,
			        	 equalTo: "#passwordForm\\:newPassword"
				      },
			     
		      },
		      highlight: function(label) {
			    $jquery(label).closest('.control-group').addClass('error');
			  },
			  success: function(label) {
			    label
			      .text('OK!').addClass('valid')
			      .closest('.control-group').addClass('success');
			  }
			  
		  });
		}

		$jquery(document).ready(function(){
			addSafeDataValidation();

			$jquery("#passwordInfoDiv").dialog({
    			autoOpen: false,
    			height: 'auto',
    			width: 'auto',
    				modal: true,
    			show: "clip",
    			hide: "clip"
    		});	
			$jquery("#passwordErrorDiv").dialog({
    			autoOpen: false,
    			height: 'auto',
    			width: 'auto',
    				modal: true,
    			show: "clip",
    			hide: "clip"
    		});	
		});

		function changePasswordJS(){
			if($jquery( "#passwordForm").valid()){
				changePassword($jquery("#passwordForm\\:activationId").val());
			}
			
			return $jquery( "#passwordForm").valid();
		}
		function openForgotPasswordInfoPanel() {
			$jquery("#passwordInfoDiv").dialog( "open" );
		}

		function openForgotPasswordErrorPanel() {
			$jquery("#passwordErrorDiv").dialog( "open" );
		}
		function closeForgotPasswordInfoPanel(){
			$jquery("#passwordInfoDiv").dialog( "close" );
		}	
		function closeForgotPasswordErrorPanel(){
			$jquery("#passwordErrorDiv").dialog( "close" );
		}		
		

		</script>
	</ui:define>
	<ui:define name="body">
	  <div class="box round first">	
	 	 	<h2>CHANGE PASSWORD</h2>
			<br/>
	  		<rich:messages infoClass="info" errorClass="error" id="errorMsg" globalOnly="true"/>	
			<br/>
  			<a4j:outputPanel id="changePasswordPanelId">
						
		    	 <h:form id="passwordForm">
		    	 <h:inputHidden id="activationId" value="#{forgotPasswordAction.activationId}" />
					<table id="changePasswordTable" class="form">
			  			<tr>
			  				<td class="col1">
								<label class="control-label" for="newPassword">New Password:</label>
							</td>
			  				<td class="col2">
			  					<h:inputSecret value="#{forgotPasswordAction.newPassword}" id="newPassword"/>
			  				</td>
			  			</tr>
			  			<tr>
			  				<td class="col1">
								<label class="control-label" for="confirmPassword">Confirm Password:</label>
							</td>
							<td class="col2">
			  					<h:inputSecret value="#{forgotPasswordAction.confirmNewPassword}" id="confirmPassword"/>
			  				</td>
			  			
			  			</tr>
		  			</table>
		  			<table>
						<tr>
				        	<td>
				             	<input type="button"  class="button" id="changePasswordBtn" name="changePasswordBtn" value="Change Password" onclick="changePasswordJS();"/>
				             	<a4j:jsFunction name="changePassword" action="#{forgotPasswordAction.updatePassword}"  reRender="errorMsg" status="showLoadingStatus"
				             	   oncomplete="if(#{forgotPasswordAction.updatePasswordValid}){
				             	   	
				             	   		openForgotPasswordInfoPanel();
				             	   
				             	   }	
				             	   else {
				             	   		openForgotPasswordErrorPanel();
				             	   }"
				             	   
				             	   limitToList="true">
				             		<a4j:actionparam name="param1"  assignTo="#{forgotPasswordAction.activationId}" />
				             	</a4j:jsFunction>
				          	</td>
		  				</tr>
					</table>
				</h:form>
			</a4j:outputPanel>
		</div>
		<div id="passwordInfoDiv" title="Important!!"  style="display:none;width=160px">
		     <a4j:outputPanel id="forgotPasswordInfoPanel">
		     	<table cellspacing="10" cellpadding="0" width="100%">
							<tr>
								<td colspan="2" style="color: maroon; white-space: normal">
									<fieldset style="text-align: center; font-size: 11px; border-color: maroon; margin-bottom: 15px">
										<h:outputText id="custNo" styleClass="label" value="Your password has been successfully updated">
										</h:outputText>
										<br />
									</fieldset>
								</td>
							</tr>
							<tr>
								<td>
									<input type="button" class="button" value="OK" onclick="closeForgotPasswordInfoPanel();" />
								</td>
							</tr>
					</table>
		     	<br/>
			</a4j:outputPanel>
				
			</div>
			
			<div id="passwordErrorDiv" title="Important!!"  style="display:none;width=160px">
		     <a4j:outputPanel id="forgotPasswordErrorPanel">
		     	<table cellspacing="10" cellpadding="0" width="100%">
							<tr>
								<td colspan="2" style="color: maroon; white-space: normal">
									<fieldset style="text-align: center; font-size: 11px; border-color: maroon; margin-bottom: 15px">
										<h:outputText id="custNoErr" styleClass="label" value="Unable to update password for your account. Please contact System Administrator">
										</h:outputText>
										<br />
									</fieldset>
								</td>
							</tr>
							<tr>
								<td>
									<input type="button" class="button" value="OK" onclick="closeForgotPasswordErrorPanel();" />
								</td>
							</tr>
					</table>
		     	<br/>
			</a4j:outputPanel>
				
			</div>	
	</ui:define>	
	
		
	
	</ui:composition>