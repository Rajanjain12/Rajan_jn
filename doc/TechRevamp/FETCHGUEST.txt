USE `KyobeeTechRevamp`;
DROP procedure IF EXISTS `FETCHGUEST`;

DELIMITER $$
USE `KyobeeTechRevamp`$$
CREATE DEFINER=`root`@`%` PROCEDURE `FETCHGUEST`(IN `P_UUID` VARCHAR(255), OUT `OP_ORGID` INT,OUT `OP_GUESTID` INT, OUT `OP_GUESTNAME` VARCHAR(255),  OUT `OP_NOOFPEOPLE` INT, OUT `OP_SMS` VARCHAR(255), OUT `OP_EMAIL` VARCHAR(255), OUT `OP_PREFTYPE` VARCHAR(15), OUT `OP_OPTIN` INT, OUT `OP_RANK` INT, OUT `OP_NOTE` VARCHAR(255), OUT `OP_CSVSEATINGPREF` VARCHAR(255), OUT `OP_NOWSERVERINGPARTY` INT, OUT `OP_TOTALWAITINGGUEST` INT, OUT `OP_TOTALWAITTIME` INT, OUT `OP_NOOFPARTIESAHEAD` INT, OUT `OP_GUESTTOBENOTIFIED` INT,OUT `OP_CLIENTBASE` VARCHAR(50))
BEGIN

DECLARE V_RANK , V_TOTAL_GUEST , V_NOTIFYUSERCOUNT INT;
DECLARE CONTINUE HANDLER FOR SQLSTATE '02000' set V_RANK=1;


-- Fetch record from the GUEST Table based on UUID
SELECT 
OrganizationID,GuestID,Name, NoOfPeople, Sms, Email , PrefType, Optin, Rank, SeatingPreference, Note INTO
OP_ORGID, OP_GUESTID, OP_GUESTNAME,OP_NOOFPEOPLE, OP_SMS, OP_EMAIL, OP_PREFTYPE, OP_OPTIN, OP_RANK, OP_CSVSEATINGPREF , OP_NOTE
FROM GUEST 
WHERE UUID = P_UUID;


-- Call the Procedure to get the header metrics calcualted
CALL `CALCHEADERMETRICS`(OP_ORGID, @OP_NOWSERVERINGPARTY, @OP_TOTALWAITINGGUEST, @OP_TOTALWAITTIME , @OP_NOOFPARTIESAHEAD, @OP_GUESTTOBENOTIFIED, @OP_GUESTNOTIFIEDWAITTIME,@OP_PERPARTYWAITTIME, @OP_NOTIFYUSERCOUNT,@OP_CLIENTBASE);


-- Set Return Variables
SELECT @OP_NOWSERVERINGPARTY INTO OP_NOWSERVERINGPARTY;
SELECT @OP_TOTALWAITTIME INTO OP_TOTALWAITTIME;
SELECT @OP_TOTALWAITINGGUEST INTO OP_TOTALWAITINGGUEST;
SELECT @OP_CLIENTBASE INTO @OP_CLIENTBASE;
	
END$$

DELIMITER ;

