USE `KyobeeTechRevamp`;
DROP procedure IF EXISTS `UPDATEGUESTREVAMP`;

DELIMITER $$
USE `KyobeeTechRevamp`$$
CREATE DEFINER=`root`@`%` PROCEDURE `UPDATEGUESTREVAMP`(IN `P_ORGID` INT, IN `P_GUESTID` INT, IN `P_GUESTNAME` VARCHAR(255) CHARACTER SET utf8, IN `P_NOOFCHILDREN` INT, IN `P_NOOFADULTS` INT, IN `P_NOOFINFANTS` INT, IN `P_NOOFPEOPLE` INT, IN `P_LANGUAGEPREFID` INT, IN `P_PARTYTYPE` INT, IN `P_DEVICETYPE` VARCHAR(255), 
 IN `P_DEVICEID` VARCHAR(255) , IN `P_CONTACTNO` VARCHAR(45), IN `P_EMAIL` VARCHAR(255), IN `P_PREFTYPE` VARCHAR(15), IN `P_OPTIN` INT, IN `P_CSVSEATINGPREF` VARCHAR(255), IN `P_NOTE` VARCHAR(255) CHARACTER SET utf8, OUT `OP_NOWSERVERINGPARTY` INT, OUT `OP_TOTALWAITINGGUEST` INT, OUT `OP_TOTALWAITTIME` INT, OUT `OP_NOOFPARTIESAHEAD` INT, OUT `OP_GUESTTOBENOTIFIED` INT, OUT `OP_GUESTNOTIFIEDWAITTIME` INT, OUT `OP_CLIENTBASE` VARCHAR(50))
BEGIN

UPDATE GUEST 
SET 
    Name = P_GUESTNAME,
    NoOfChildren = P_NOOFCHILDREN,
    NoOfAdults = P_NOOFADULTS,
    NoOfInfants = P_NOOFINFANTS,
    NoOfPeople = P_NOOFPEOPLE,
    LanguagePrefID = P_LANGUAGEPREFID,
    PartyType = P_PARTYTYPE,
	ContactNo= P_CONTACTNO,
    Email = P_EMAIL,
    PrefType = P_PREFTYPE,
    Optin = P_OPTIN,
    SeatingPreference = P_CSVSEATINGPREF,
    Status = 'CHECKIN',
    Note = P_NOTE,
    ModifiedBy = 'admin' ,
    ModifiedAt = NOW()
WHERE
    GUESTID = P_GUESTID;



-- Call the Procedure to get the header metrics calcualted
CALL `CALCHEADERMETRICS`(P_ORGID, @OP_NOWSERVERINGPARTY, @OP_TOTALWAITINGGUEST, @OP_TOTALWAITTIME , @OP_NOOFPARTIESAHEAD, @OP_GUESTTOBENOTIFIED, @OP_GUESTNOTIFIEDWAITTIME,@OP_PERPARTYWAITTIME, @OP_NOTIFYUSERCOUNT,@OP_CLIENTBASE);
  
-- Already that particular guest has received notification
IF(row_count() = 0) THEN
    SET OP_GUESTTOBENOTIFIED := -1;
ELSE
 SELECT @OP_GUESTTOBENOTIFIED INTO  OP_GUESTTOBENOTIFIED;    
END IF;   


-- Set Return Variables
SELECT @OP_NOWSERVERINGPARTY INTO  OP_NOWSERVERINGPARTY;
SELECT @OP_TOTALWAITTIME INTO  OP_TOTALWAITTIME;
SELECT @OP_NOOFPARTIESAHEAD INTO  OP_NOOFPARTIESAHEAD;
SELECT @OP_TOTALWAITINGGUEST INTO OP_TOTALWAITINGGUEST;
SELECT @OP_GUESTNOTIFIEDWAITTIME INTO OP_GUESTNOTIFIEDWAITTIME;
SELECT @OP_CLIENTBASE INTO OP_CLIENTBASE;
 
END$$

DELIMITER ;

