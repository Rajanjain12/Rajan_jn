USE `KyobeeTechRevamp`;
DROP procedure IF EXISTS `UPDATEGUESTSTATUSREVAMP`;

DELIMITER $$
USE `KyobeeTechRevamp`$$
CREATE DEFINER=`root`@`%` PROCEDURE `UPDATEGUESTSTATUSREVAMP`(IN `P_ORGID` INT, IN `P_GUESTID` INT, IN `P_CALLOUT` INT, IN `P_INCOMPLETE` INT, IN `P_SEATED` INT, IN `P_DELETED` INT, OUT `OP_NOWSERVERINGPARTY` INT, OUT `OP_TOTALWAITINGGUEST` INT, OUT `OP_TOTALWAITTIME` INT, OUT `OP_NOOFPARTIESAHEAD` INT, OUT `OP_GUESTTOBENOTIFIED` INT, OUT `OP_GUESTNOTIFIEDWAITTIME` INT, OUT `OP_CLIENTBASE` VARCHAR(50))
BEGIN

DECLARE V_STATUS VARCHAR(10);
DECLARE V_SEATEDDATE DATE;
DECLARE UPDATE_REQD_FLAG INT DEFAULT 0;

-- Check the condition and decide simple update or sensetive update operation
IF P_SEATED = 1 THEN
   SET V_STATUS := 'SEATED';
   SET V_SEATEDDATE := now();
   UPDATE GUEST SET status = V_STATUS, SeatedTime = V_SEATEDDATE WHERE GUESTID = P_GUESTID;
   SET UPDATE_REQD_FLAG := 1;
ELSEIF P_DELETED = 1 THEN
   SET V_STATUS := 'DELETED';
   SET V_SEATEDDATE := now();
   UPDATE GUEST SET status = V_STATUS, SeatedTime = V_SEATEDDATE WHERE GUESTID = P_GUESTID;
   SET UPDATE_REQD_FLAG := 1;
ELSE 
   SET V_STATUS := 'CHECKIN';
   SET V_SEATEDDATE := null;
END IF;


IF UPDATE_REQD_FLAG = 0 THEN
-- UPDATE the GUEST RECORD
UPDATE GUEST 
SET 
    Status = V_STATUS,
    IncompleteParty = IF(P_INCOMPLETE = 0, IncompleteParty ,P_INCOMPLETE),
    CalloutCount = IF(P_CALLOUT = 0,CalloutCount, IFNULL(CalloutCount,0) + P_CALLOUT),
    SeatedTime = V_SEATEDDATE,
    ModifiedBy = 'admin' ,
    ModifiedAt = NOW()
WHERE
    GUESTID = P_GUESTID;
END IF;

IF P_DELETED = 1 || P_SEATED = 1 || P_INCOMPLETE = 1 || P_CALLOUT = 1 THEN

-- Call the Procedure to get the header metrics calcualted
CALL `CALCHEADERMETRICS`(P_ORGID, @OP_NOWSERVERINGPARTY, @OP_TOTALWAITINGGUEST, @OP_TOTALWAITTIME , @OP_NOOFPARTIESAHEAD, @OP_GUESTTOBENOTIFIED, @OP_GUESTNOTIFIEDWAITTIME,@OP_PERPARTYWAITTIME, @OP_NOTIFYUSERCOUNT,@OP_CLIENTBASE);

-- Update guest if it has not yet received the level 2 notification
UPDATE GUEST  SET RecvLeveltwo=1  WHERE GuestID = @OP_GUESTTOBENOTIFIED AND RecvLeveltwo IS NULL;
  
-- Already that particular guest has received notification
IF(row_count() = 0) THEN
    SET OP_GUESTTOBENOTIFIED := -1;
ELSE
 SELECT @OP_GUESTTOBENOTIFIED INTO  OP_GUESTTOBENOTIFIED;    
END IF;   


-- Set Return Variables
SELECT @OP_NOWSERVERINGPARTY INTO  OP_NOWSERVERINGPARTY;
SELECT @OP_TOTALWAITTIME INTO  OP_TOTALWAITTIME;
SELECT @OP_NOOFPARTIESAHEAD INTO  OP_NOOFPARTIESAHEAD;
SELECT @OP_TOTALWAITINGGUEST INTO OP_TOTALWAITINGGUEST;
SELECT @OP_GUESTNOTIFIEDWAITTIME INTO OP_GUESTNOTIFIEDWAITTIME;
SELECT @OP_CLIENTBASE INTO OP_CLIENTBASE;
 
END IF;      
 
END$$

DELIMITER ;

