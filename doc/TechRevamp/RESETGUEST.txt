USE `KyobeeTechRevamp`;
DROP procedure IF EXISTS `RESETGUEST`;

DELIMITER $$
USE `KyobeeTechRevamp`$$
CREATE DEFINER=`root`@`%` PROCEDURE `RESETGUEST`()
    NO SQL
    COMMENT 'This is the method to reset the data everyday'
BEGIN


   DECLARE   V_ORGID ,  done INT default 0;
 
	
DECLARE orgrecords CURSOR
FOR
 SELECT OrganizationID
 FROM ORGANIZATION 
where ACTIVE = 1 ; 
  DECLARE  CONTINUE HANDLER FOR SQLSTATE '02000'  SET done = 1;
   -- DECLARE CONTINUE HANDLER FOR SQLSTATE '23000' SET @x2 = 1;


OPEN orgrecords;
   
   
   REPEAT
			-- SELECT 'BEfore FEtch';
            FETCH orgrecords INTO  V_ORGID;
            IF  not done THEN
            
			
            SELECT * FROM GUEST WHERE ORGANIZATIONID=V_ORGID FOR UPDATE;
             
            INSERT INTO GUESTRESET (GuestID, OrganizationID, Name, Uuid , NoOfChildren , NoOfAdults, NoOfInfants , NoOfPeople, DeviceType, DeviceId, ContactNo, Email, PrefType, LanguagePrefID, Optin, Rank, Status, SeatingPreference, RecvLeveltwo, CalloutCount, Note, IncompleteParty, ResetTime, CheckinTime, SeatedTime, CreatedBy, CreatedAt , ModifiedBy , ModifiedAt)
                 SELECT GuestID, OrganizationID, Name, Uuid , NoOfChildren , NoOfAdults, NoOfInfants , NoOfPeople , DeviceType, DeviceId, ContactNo, Email, PrefType, LanguagePrefID,Optin, Rank, Status, SeatingPreference, RecvLeveltwo, CalloutCount, Note, IncompleteParty, now(), CheckinTime, SeatedTime, CreatedBy, CreatedAt , ModifiedBy , ModifiedAt
                 FROM GUEST WHERE ORGANIZATIONID=ORGID;
            -- SELECT 'after update';
            
          Insert into GUESTMARKETINGPREFERENCESRESET(GusetMarketingPrefResetID,PrefID,GuestID,CreatedBy,CreatedAt) 
            select GuestMarketingPrefID,PrefID,GuestID,CreatedBy,now()  from
            GUESTMARKETINGPREFERENCES where GuestID in (SELECT guestID FROM GUEST WHERE ORGANIZATIONID=ORGID);
	
            Delete from GUESTMARKETINGPREFERENCES WHERE GuestID in (SELECT guestID FROM GUEST WHERE ORGANIZATIONID=V_ORGID);
            
            DELETE FROM GUEST WHERE ORGANIZATIONID=V_ORGID;
             
			COMMIT;
            
            END IF;

	UNTIL done END REPEAT;
   CLOSE orgrecords;

END$$

DELIMITER ;

