USE `KyobeeTechRevamp`;
DROP procedure IF EXISTS `TRANSACTIONSUCCESS`;

DELIMITER $$
USE `KyobeeTechRevamp`$$
CREATE DEFINER=`root`@`%` PROCEDURE `TRANSACTIONSUCCESS`(IN `ORGSUBSCRIPTIONID` INT, IN `ORGCARDDETAILID` INT, IN `ORGPAYMENTID` INT, IN `INVOICESTATUS` VARCHAR(100), IN `CURRACTIVESUBSC` VARCHAR(10), IN `SUBSCSTATUS` VARCHAR(255), IN `VAULTID` VARCHAR(255), IN `TRANSACTIONID` VARCHAR(50), IN `PAYMENTDATETIME` TIMESTAMP, IN `PAYMENTSTATUSREASON` VARCHAR(1000), 
 IN `PAYMENTSTATUS` VARCHAR(100) , IN `RENEWALTYPE` VARCHAR(100) )
BEGIN

UPDATE ORGANIZATIONSUBSCRIPTION 
SET 
    InvoiceStatus = INVOICESTATUS,
    CurrentActiveSubscription = CURRACTIVESUBSC,
    SubscriptionDate = NOW(),
    StartDate = NOW(),
	RenewalType = RENEWALTYPE,
    Active = 1
WHERE
    OrganizationSubscriptionID = ORGSUBSCRIPTIONID;
--
UPDATE ORGANIZATIONSUBSCRIPTIONDETAIL 
SET 
    SubscriptionStatus = SUBSCSTATUS,
    CurrentActiveSubscription = CURRACTIVESUBSC,
    SubscribedDate = NOW(),
    StartDate = NOW(),
    Active = 1
WHERE
    SubscriptionID = ORGSUBSCRIPTIONID;

--
UPDATE ORGANIZATIONCARDDETAIL 
SET 
    VaultID = VAULTID
WHERE
    OrganizationCardDetailID = ORGCARDDETAILID; 
    
--
UPDATE ORGANIZATIONPAYMENT 
SET 
    TransactionID = TRANSACTIONID,
    PaymentDateTime = PAYMENTDATETIME,
    PaymentStatus = PAYMENTSTATUS,
    PaymentStatusReason = PAYMENTSTATUSREASON,
    Active = 1
WHERE
    OrganizationPaymentID = ORGPAYMENTID;    

END$$

DELIMITER ;

